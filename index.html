<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <link rel="icon" type="image/png" href="logo.png">
    
    <title>Dashboard Casa Nostra | Acesso Restrito</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const CLIENT_ID = '967312917527-sr2r24n2m9g0r3c5b7b87hpop3se3vh8.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBuVMvZuFTYAIcrlzK3YnB0sTGYsmlvZFA';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email';
        const ABA_ALVO = "Dashboard_Indicadores IPCA";

        // --- LISTA DE ACESSO AUTORIZADO (ATUALIZADA) ---
        const EMAILS_AUTORIZADOS = [
            'lfperacchi@gmail.com',
            'lfperacchi.investidor@gmail.com',
            'miforalozzo@gmail.com',
            'mepagliosa11@gmail.com',
            'sabrinapagliosaarquitetura@gmail.com'
        ];

        let tokenClient;
        let mainChart = null;
        let modalChart = null;
        let currentFileId = localStorage.getItem('casaNostra_lastFileId');
        let currentFileName = localStorage.getItem('casaNostra_lastFileName');

        function gapiLoaded() {
            gapi.load('client:picker', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, ux_mode: 'popup',
                callback: async (resp) => {
                    if (resp.error) return;
                    
                    const isAuthorized = await verificarAcesso(resp.access_token);
                    if (!isAuthorized) return;

                    if (currentFileId) await downloadAndProcessFile(currentFileId);
                    else createPicker(resp.access_token);
                }
            });
        }

        async function verificarAcesso(accessToken) {
            try {
                const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const userData = await resp.json();
                
                if (EMAILS_AUTORIZADOS.includes(userData.email.toLowerCase())) {
                    return true;
                } else {
                    alert("ACESSO NEGADO: O e-mail " + userData.email + " nÃ£o tem permissÃ£o.");
                    window.location.reload(); 
                    return false;
                }
            } catch (err) {
                alert("Erro ao validar identidade.");
                return false;
            }
        }

        function handleAuthClick(forcePicker = false) {
            if (forcePicker) {
                currentFileId = null;
                localStorage.removeItem('casaNostra_lastFileId');
            }
            if (tokenClient) tokenClient.requestAccessToken({prompt: currentFileId ? '' : 'consent'});
        }

        function createPicker(accessToken) {
            const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
            const picker = new google.picker.PickerBuilder()
                .addView(view).setOAuthToken(accessToken).setDeveloperKey(API_KEY)
                .setCallback(pickerCallback).setOrigin(window.location.protocol + '//' + window.location.host).build();
            picker.setVisible(true);
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                currentFileId = data.docs[0].id;
                currentFileName = data.docs[0].name;
                localStorage.setItem('casaNostra_lastFileId', currentFileId);
                localStorage.setItem('casaNostra_lastFileName', currentFileName);
                await downloadAndProcessFile(currentFileId);
            }
        }

        async function downloadAndProcessFile(fileId) {
            const token = gapi.client.getToken();
            if (!token) return handleAuthClick();
            
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${token.access_token}` }
                });
                if (!response.ok) throw new Error();
                const workbook = XLSX.read(new Uint8Array(await response.arrayBuffer()), {type: 'array', cellComments: true});
                processDashboard(workbook.Sheets[ABA_ALVO]);
                document.getElementById('file-status').innerText = "Conectado: " + (currentFileName || "Planilha");
            } catch (err) {
                handleAuthClick();
            }
        }
    </script>

    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <style>
        .bg-casa-red { background-color: #BE1E2D; }
        .text-casa-red { color: #BE1E2D; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .card-kpi:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -5px rgba(190, 30, 45, 0.2); transition: all 0.3s; }
        .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: #000; color: white; border-radius: 50%; font-size: 13px; cursor: help; margin-left: 10px; font-weight: bold; font-style: italic; vertical-align: middle; }
        .hover-note { opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .group:hover .hover-note { opacity: 1; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <div id="detailsModal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-6xl w-full overflow-hidden flex flex-col md:flex-row h-[85vh]">
            <div class="p-8 md:w-1/3 bg-gray-50 border-r border-gray-100 flex flex-col overflow-y-auto">
                <button onclick="closeModal()" class="text-gray-400 hover:text-black mb-8 font-bold text-xs uppercase text-left tracking-widest">âœ• Fechar</button>
                <div class="group relative mb-8">
                    <h2 class="text-2xl font-black uppercase italic text-casa-red leading-tight flex items-center">
                        <span id="modalTitle">Indicador</span>
                        <span id="modalInfoIcon" class="info-icon hidden">i</span>
                    </h2>
                    <div id="modalMetodologia" class="absolute z-20 top-full left-0 mt-2 w-full bg-black text-white p-4 rounded-xl text-[11px] opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-2xl italic border border-gray-700 leading-relaxed"></div>
                </div>
                <div class="space-y-6 flex-grow">
                    <div class="p-5 bg-white rounded-2xl shadow-sm border border-gray-100 group transition-all">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Realizado 2024</span>
                        <p id="modalV24" class="text-2xl font-black mt-1">0</p>
                        <p id="modalComm24" class="text-[11px] text-gray-600 mt-2 border-t pt-2 italic hover-note"></p>
                    </div>
                    <div class="p-5 bg-white rounded-2xl shadow-sm border-l-4 border-casa-red group transition-all">
                        <span class="text-[10px] font-bold text-gray-400 uppercase text-casa-red tracking-widest">Realizado 2025</span>
                        <p id="modalV25" class="text-2xl font-black mt-1">0</p>
                        <p id="modalComm25" class="text-[11px] text-gray-600 mt-2 border-t pt-2 italic hover-note"></p>
                    </div>
                </div>
                <div id="modalVarBox" class="mt-8 p-6 rounded-2xl text-center shadow-sm">
                    <span class="text-[10px] font-bold uppercase block mb-1 tracking-widest opacity-60">VariaÃ§Ã£o Anual</span>
                    <span id="modalVarValue" class="text-4xl font-black tracking-tighter">0%</span>
                </div>
            </div>
            <div class="p-10 md:w-2/3 bg-white h-full flex flex-col justify-center">
                <canvas id="modalChartCanvas"></canvas>
            </div>
        </div>
    </div>

    <nav class="bg-black text-white flex justify-between items-center shadow-xl border-b-4 border-casa-red sticky top-0 z-40 h-20 px-6">
        <div class="flex items-center gap-6 h-full">
            <img src="logo.png" alt="Logo" class="h-full w-auto object-contain py-1">
            <div>
                <h1 class="text-lg font-black uppercase tracking-tight leading-none">Indicadores de Desempenho</h1>
                <span id="file-status" class="text-casa-red text-[10px] tracking-[0.4em] uppercase">Casa Nostra Intel</span>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="gerarPDF()" class="bg-white text-black hover:bg-gray-100 px-5 py-2 rounded-full text-[10px] font-black transition-all shadow-lg flex items-center gap-2">ðŸ“¥ PDF</button>
            <button onclick="handleAuthClick()" class="bg-gray-800 text-white hover:bg-gray-700 px-5 py-2 rounded-full text-[10px] font-black transition-all shadow-lg flex items-center gap-2">ðŸ”„ ATUALIZAR</button>
            <button onclick="handleAuthClick(true)" class="bg-casa-red hover:bg-red-700 px-5 py-2 rounded-full text-[10px] font-black transition-all shadow-lg flex items-center gap-2">ðŸ“‚ TROCAR</button>
        </div>
    </nav>

    <main id="dashboard-content" class="p-6 max-w-[1500px] mx-auto">
        <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12"></div>
        <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 h-[500px]">
            <canvas id="mainChartCanvas"></canvas>
        </div>
    </main>

    <script>
        function cleanComment(text) {
            if (!text) return "";
            return text.split('\n')
                .filter(line => !line.includes('ID#') && !line.includes('====') && !line.match(/\d{4}-\d{2}-\d{2}/))
                .join(' ').trim();
        }

        function getComment(sheet, rowIdx, colIdx) {
            const cellRef = XLSX.utils.encode_cell({r: rowIdx, c: colIdx});
            const cell = sheet[cellRef];
            return (cell && cell.c && cell.c.length > 0) ? cleanComment(cell.c[0].t) : "";
        }

        function formatVal(val, isPercent) {
            let num = Number(val) || 0;
            if (isPercent) {
                let displayVal = num < 1 && num !== 0 ? num * 100 : num;
                return displayVal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';
            }
            return num.toLocaleString('pt-BR');
        }

        function processDashboard(sheet) {
            const container = document.getElementById('kpi-container');
            container.innerHTML = '';
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            const labels = [], d24 = [], d25 = [], cB = [], cK = [], cL = [];

            rows.forEach((row, index) => {
                if (index === 0 || !row[1]) return;
                const cat = row[1], v24 = Number(row[10]) || 0, v25 = Number(row[11]) || 0;
                const isP = cat.toLowerCase().includes('margem');

                const commB = getComment(sheet, index, 1);
                const commK = getComment(sheet, index, 10);
                const commL = getComment(sheet, index, 11);

                let varPct = v24 !== 0 ? ((v25 - v24) / Math.abs(v24)) * 100 : 0;
                const varColor = varPct >= 0 ? 'text-green-600' : 'text-red-600';

                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-3xl border border-gray-100 shadow-sm cursor-pointer card-kpi h-52 flex flex-col justify-between";
                card.onclick = () => openModal(cat, v24, v25, commB, commK, commL, varPct);
                
                card.innerHTML = `
                    <div>
                        <p class="text-[9px] text-gray-400 font-black uppercase tracking-widest flex items-center">
                            ${cat} ${commB ? '<span class="info-icon">i</span>' : ''}
                        </p>
                        <span class="text-3xl font-black tracking-tighter text-black block mt-2">${formatVal(v25, isP)}</span>
                    </div>
                    <div class="border-t border-gray-50 pt-3 mt-3 flex justify-between items-center">
                        <span class="text-[10px] text-gray-300 font-bold uppercase">2024: ${formatVal(v24, isP)}</span>
                        <span class="${varColor} text-[11px] font-black">${varPct > 0 ? '+' : ''}${varPct.toFixed(1)}%</span>
                    </div>
                `;
                container.appendChild(card);

                labels.push(cat);
                d24.push(isP && v24 < 1 ? v24 * 100 : v24);
                d25.push(isP && v25 < 1 ? v25 * 100 : v25);
                cB.push(commB); cK.push(commK); cL.push(commL);
            });
            renderMainChart(labels, d24, d25, cB, cK, cL);
        }

        function renderMainChart(labels, d24, d25, cB, cK, cL) {
            const ctx = document.getElementById('mainChartCanvas').getContext('2d');
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '2024', data: d24, backgroundColor: '#000', notes: cK, methodology: cB },
                        { label: '2025', data: d25, backgroundColor: '#BE1E2D', notes: cL, methodology: cB }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                beforeLabel: (ctx) => ctx.dataset.methodology[ctx.dataIndex] ? 'DefiniÃ§Ã£o: ' + ctx.dataset.methodology[ctx.dataIndex] : null,
                                afterLabel: (ctx) => ctx.dataset.notes[ctx.dataIndex] ? 'Nota: ' + ctx.dataset.notes[ctx.dataIndex] : null
                            }
                        }
                    }
                }
            });
        }

        function openModal(label, v24, v25, cb, ck, cl, varPct) {
            const isP = label.toLowerCase().includes('margem');
            document.getElementById('modalTitle').innerText = label;
            document.getElementById('modalV24').innerText = formatVal(v24, isP);
            document.getElementById('modalV25').innerText = formatVal(v25, isP);
            
            const met = document.getElementById('modalMetodologia');
            const icon = document.getElementById('modalInfoIcon');
            if (cb) { met.innerText = cb; met.classList.remove('hidden'); icon.classList.remove('hidden'); }
            else { met.classList.add('hidden'); icon.classList.add('hidden'); }

            document.getElementById('modalComm24').innerText = ck || "Sem comentÃ¡rios.";
            document.getElementById('modalComm25').innerText = cl || "Sem comentÃ¡rios.";
            
            const vVal = document.getElementById('modalVarValue');
            const vBox = document.getElementById('modalVarBox');
            vVal.innerText = (varPct > 0 ? '+' : '') + varPct.toFixed(1) + '%';
            vBox.className = varPct >= 0 ? "mt-8 p-6 rounded-2xl text-center bg-green-50 text-green-600 font-black shadow-sm" : "mt-8 p-6 rounded-2xl text-center bg-red-50 text-red-600 font-black shadow-sm";

            document.getElementById('detailsModal').style.display = 'flex';
            
            const ctx = document.getElementById('modalChartCanvas').getContext('2d');
            if (modalChart) modalChart.destroy();
            modalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['2024', '2025'],
                    datasets: [{ label: label, data: [isP ? v24*100 : v24, isP ? v25*100 : v25], backgroundColor: ['#000', '#BE1E2D'], borderRadius: 10 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; }

        function gerarPDF() {
            const element = document.getElementById('dashboard-content');
            html2pdf().set({
                margin: 10, filename: 'Dashboard_Casa_Nostra.pdf',
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            }).from(element).save();
        }
    </script>
</body>
</html>
