<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Casa Nostra Intelligence v2.3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const VERSION = "2.3.0 (Suite Integrada)";
        const CLIENT_ID = '967312917527-sr2r24n2m9g0r3c5b7b87hpop3se3vh8.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBuVMvZuFTYAIcrlzK3YnB0sTGYsmlvZFA';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email';
        
        // --- CONFIGURAÃ‡ÃƒO ---
        const SHEET_ANUAL = "Dashboard_Indicadores IPCA";
        const SHEET_TRI = "Dashboard_Trimestral IPCA";
        
        // Labels DinÃ¢micos (serÃ£o sobrescritos pelo Excel)
        let LABELS_ANUAL = ['Ano Base', 'Ano Atual']; 
        let LABELS_TRI = ['Base', 'Anterior', 'Atual']; 

        const EMAILS_AUTORIZADOS = [
            'lfperacchi@gmail.com', 'lfperacchi.investidor@gmail.com',
            'miforalozzo@gmail.com', 'mepagliosa11@gmail.com',
            'sabrinapagliosaarquitetura@gmail.com'
        ];

        let tokenClient, globalWorkbook = null;
        let currentMode = 'ANUAL'; 
        let currentFileId = localStorage.getItem('casaNostra_lastFileId');
        let charts = {}, masterData = {}, modalChart = null;

        const GRUPOS = {
            receitas: { title: "1. Receitas", tags: ['receita bruta', 'receita lÃ­quida'], div: 1000000, scale: 'M', exclude: ['cpv', 'lucro bruto'] },
            lucratividade: { title: "2. Lucratividade", tags: ['lucro operacional', 'ebit', 'ebitda', 'lucro lÃ­quido', 'lucro nominal', 'resultado operacional', 'lucro bruto'], exclude: ['margem'], div: 1000, scale: 'k' },
            margens: { title: "3. Margens", tags: ['margem ebit', 'margem lÃ­quida', 'margem ebitda'], div: 1, scale: '%' },
            opex_a: { title: "4. Pessoal e Impostos", tags: ['despesas operacionais', 'impostos totais', 'gasto com pessoal'], div: 1000, scale: 'k' },
            opex_b: { title: "5. Administrativo", tags: ['administrativo', 'publicidade', 'frota'], div: 1000, scale: 'k' },
            estoque_fin: { title: "6. Estoque e Custos", tags: ['aquisiÃ§Ã£o de produtos', 'cpv', 'estoque'], div: 1000, scale: 'k', exclude: ['pmre', 'giro'] },
            estoque_giro: { title: "7. PMRE e Giro", tags: ['pmre', 'giro de renovaÃ§Ã£o'], div: 1, scale: '', dualAxis: true },
            produtividade: { title: "8. Produtividade", tags: ['vendas por m', 'custo loja aberta', 'vendas por funcionÃ¡rio'], div: 1, scale: '' },
            capex: { title: "9. Capex e Deprec.", tags: ['capex total', 'depreciaÃ§Ã£o', 'amortizaÃ§Ã£o'], div: 1000, scale: 'k' }
        };

        function gapiLoaded() { gapi.load('client:picker', async () => { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] }); }); }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, ux_mode: 'popup',
                callback: async (resp) => {
                    if (resp.error) return;
                    if (await verificarAcesso(resp.access_token)) {
                        if (currentFileId) downloadAndProcessFile(currentFileId);
                        else createPicker(resp.access_token);
                    }
                }
            });
        }
        async function verificarAcesso(at) {
            try {
                const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${at}` } });
                const user = await resp.json();
                return EMAILS_AUTORIZADOS.includes(user.email.toLowerCase());
            } catch (e) { return false; }
        }
        function handleAuthClick(f = false) {
            if (f) { currentFileId = null; localStorage.removeItem('casaNostra_lastFileId'); }
            tokenClient.requestAccessToken({prompt: currentFileId ? '' : 'consent'});
        }
        function createPicker(at) {
            const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
            new google.picker.PickerBuilder().addView(view).setOAuthToken(at).setDeveloperKey(API_KEY).setCallback(pickerCallback).build().setVisible(true);
        }
        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                currentFileId = data.docs[0].id;
                localStorage.setItem('casaNostra_lastFileId', currentFileId);
                downloadAndProcessFile(currentFileId);
            }
        }

        async function downloadAndProcessFile(id) {
            try {
                document.getElementById('file-status').innerText = "Baixando dados...";
                const token = gapi.client.getToken();
                const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media&t=${Date.now()}`, { headers: { 'Authorization': `Bearer ${token.access_token}` } });
                const arrayBuffer = await resp.arrayBuffer();
                globalWorkbook = XLSX.read(new Uint8Array(arrayBuffer), {type: 'array', cellComments: true});
                
                renderDashboard('ANUAL'); 

            } catch (error) {
                console.error(error);
                alert("Erro ao ler arquivo.");
            }
        }

        function renderDashboard(mode) {
            currentMode = mode;
            masterData = {};
            charts = {};
            
            // Toggle Visual
            document.getElementById('btn-anual').className = mode === 'ANUAL' ? "bg-[#BE1E2D] text-white px-6 py-2 rounded-full text-[10px] font-black shadow-lg" : "bg-gray-800 text-white px-6 py-2 rounded-full text-[10px] font-black opacity-50 hover:opacity-100";
            document.getElementById('btn-tri').className = mode === 'TRIMESTRAL' ? "bg-[#BE1E2D] text-white px-6 py-2 rounded-full text-[10px] font-black shadow-lg" : "bg-gray-800 text-white px-6 py-2 rounded-full text-[10px] font-black opacity-50 hover:opacity-100";

            const sheetName = mode === 'ANUAL' ? SHEET_ANUAL : SHEET_TRI;
            const sheet = globalWorkbook.Sheets[sheetName];

            if (!sheet) {
                document.getElementById('cards-sections-container').innerHTML = `<div class="p-10 text-center text-red-600 font-bold bg-red-50 rounded-xl">ERRO: Aba "${sheetName}" nÃ£o encontrada.</div>`;
                return;
            }

            document.getElementById('file-status').innerText = `Modo: ${mode}`;
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            const headerRow = rows[0];

            // --- LEITURA DE CABEÃ‡ALHOS (AUTOMÃTICA) ---
            if (headerRow) {
                if (mode === 'ANUAL') {
                    LABELS_ANUAL = [headerRow[10] || 'Ano Base', headerRow[11] || 'Ano Atual'];
                } else {
                    LABELS_TRI = [headerRow[10] || 'Base', headerRow[11] || 'Ant.', headerRow[12] || 'Atual'];
                }
            }

            const container = document.getElementById('cards-sections-container');
            const chartsGrid = document.getElementById('charts-main-grid');
            container.innerHTML = ''; chartsGrid.innerHTML = '';

            rows.forEach((row, idx) => {
                if (idx === 0 || !row[1]) return; 
                const labelRaw = row[1].toString(); const labelLow = labelRaw.toLowerCase().trim();
                
                if (mode === 'ANUAL') {
                    masterData[labelLow] = { 
                        original: labelRaw, 
                        desc: getComment(sheet, idx, 1),
                        v1: Number(row[10]) || 0, // K
                        v2: Number(row[11]) || 0, // L
                        v3: null,
                        note1: getComment(sheet, idx, 10),
                        note2: getComment(sheet, idx, 11)
                    };
                } else {
                    masterData[labelLow] = { 
                        original: labelRaw, 
                        desc: getComment(sheet, idx, 1),
                        v1: Number(row[10]) || 0, // K
                        v2: Number(row[11]) || 0, // L
                        v3: Number(row[12]) || 0, // M
                        note1: row[13] || ""       // N
                    };
                }
            });

            // RENDERIZAÃ‡ÃƒO
            Object.keys(GRUPOS).forEach(key => {
                const config = GRUPOS[key];
                if (key === 'estoque_giro' && mode === 'TRIMESTRAL') return;

                const section = document.createElement('div');
                section.innerHTML = `<div class="section-header">${config.title}</div><div id="grid-${key}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>`;
                container.appendChild(section);

                const chartCard = document.createElement('div');
                chartCard.className = `chart-card ${key === 'receitas' ? 'lg:col-span-2' : ''}`;
                chartCard.innerHTML = `<div class="font-black text-black text-lg uppercase mb-4">${config.title}</div><div class="h-80"><canvas id="chart_${key}"></canvas></div>`;
                chartsGrid.appendChild(chartCard);

                const used = new Set();
                Object.keys(masterData).forEach(mKey => {
                    if (!(config.exclude && config.exclude.some(e => mKey.includes(e))) && config.tags.some(t => mKey.includes(t)) && !used.has(mKey)) {
                        used.add(mKey); const it = masterData[mKey];
                        
                        let cardHtml = "";
                        if (mode === 'ANUAL') {
                            const varPct = it.v1 !== 0 ? ((it.v2 - it.v1) / Math.abs(it.v1)) * 100 : 0;
                            cardHtml = `<div><p class="text-[9px] text-gray-400 font-black uppercase tracking-widest flex items-center" title="${it.desc}">${it.original} ${it.desc ? '<span class="info-icon">i</span>' : ''}</p>
                                        <span class="text-3xl font-black block mt-2">${formatVal(it.v2, mKey.includes('margem'))}</span></div>
                                        <div class="flex justify-between border-t pt-3">
                                        <span class="text-[10px] text-gray-300">${LABELS_ANUAL[0]}: ${formatVal(it.v1, mKey.includes('margem'))}</span>
                                        <span class="${varPct >= 0 ? 'text-green-600' : 'text-red-600'} text-[11px] font-bold">${varPct > 0 ? '+' : ''}${varPct.toFixed(1)}%</span></div>`;
                        } else {
                            const varYoY = it.v1 !== 0 ? ((it.v3 - it.v1) / Math.abs(it.v1)) * 100 : 0;
                            const varQoQ = it.v2 !== 0 ? ((it.v3 - it.v2) / Math.abs(it.v2)) * 100 : 0;

                            cardHtml = `<div><p class="text-[9px] text-gray-400 font-black uppercase tracking-widest flex items-center" title="${it.desc}">${it.original} ${it.desc ? '<span class="info-icon">i</span>' : ''}</p>
                                        <span class="text-3xl font-black block mt-2">${formatVal(it.v3, mKey.includes('margem'))}</span></div>
                                        <div class="flex justify-between border-t pt-3 gap-2">
                                            <div class="flex flex-col"><span class="text-[8px] text-gray-400 uppercase">vs ${LABELS_TRI[0]}</span><span class="${varYoY >= 0 ? 'text-green-600' : 'text-red-600'} text-[10px] font-bold">${varYoY > 0 ? '+' : ''}${varYoY.toFixed(1)}%</span></div>
                                            <div class="flex flex-col border-l pl-2"><span class="text-[8px] text-gray-400 uppercase">vs ${LABELS_TRI[1]}</span><span class="${varQoQ >= 0 ? 'text-green-600' : 'text-red-600'} text-[10px] font-bold">${varQoQ > 0 ? '+' : ''}${varQoQ.toFixed(1)}%</span></div>
                                        </div>`;
                        }

                        const card = document.createElement('div');
                        card.className = "bg-white p-6 rounded-3xl border border-gray-100 shadow-sm cursor-pointer card-kpi flex flex-col justify-between h-44 hover:shadow-md transition-all";
                        card.innerHTML = cardHtml;
                        card.onclick = function() { openModal(it, mode); };
                        document.getElementById(`grid-${key}`).appendChild(card);
                    }
                });
                renderChart(key, masterData, mode);
            });
        }

        function renderChart(key, data, mode) {
            const config = GRUPOS[key]; 
            const ctx = document.getElementById(`chart_${key}`).getContext('2d');
            const used = new Set();
            
            if (mode === 'ANUAL') {
                const labels = [], d1 = [], d2 = [], dual1 = [], dual2 = [], info = [];
                Object.keys(data).forEach(dKey => {
                    if (!(config.exclude && config.exclude.some(e => dKey.includes(e))) && config.tags.some(t => dKey.includes(t)) && !used.has(dKey)) {
                        if (key === 'produtividade' && dKey.includes('vendas por m')) return;
                        used.add(dKey); const it = data[dKey];
                        if (config.dualAxis) {
                            if (dKey.includes('pmre')) { d1.push(it.v1); d2.push(it.v2); labels.push(it.original); }
                            else { dual1.push(it.v1); dual2.push(it.v2); }
                        } else {
                            labels.push(it.original); info.push(it.desc);
                            d1.push(key === 'margens' ? (it.v1 < 1 ? it.v1*100 : it.v1) : it.v1/config.div);
                            d2.push(key === 'margens' ? (it.v2 < 1 ? it.v2*100 : it.v2) : it.v2/config.div);
                        }
                    }
                });
                charts[key] = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: config.dualAxis ? ['GestÃ£o'] : labels, datasets: config.dualAxis ? [
                        { label: `PMRE ${LABELS_ANUAL[0]}`, data: d1, backgroundColor: '#000', yAxisID: 'y' }, { label: `PMRE ${LABELS_ANUAL[1]}`, data: d2, backgroundColor: '#BE1E2D', yAxisID: 'y' },
                        { label: `Giro ${LABELS_ANUAL[0]}`, data: dual1, backgroundColor: '#666', yAxisID: 'y1' }, { label: `Giro ${LABELS_ANUAL[1]}`, data: dual2, backgroundColor: '#FF8A96', yAxisID: 'y1' }
                    ] : [{ label: LABELS_ANUAL[0], data: d1, backgroundColor: '#000', info: info }, { label: LABELS_ANUAL[1], data: d2, backgroundColor: '#BE1E2D', info: info }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { afterBody: (ctx) => ctx[0].dataset.info ? '\n'+ctx[0].dataset.info[ctx[0].dataIndex] : '' }}}, scales: { y: { position: 'left', ticks: { callback: v => v.toLocaleString('pt-BR') + config.scale } }, y1: { display: !!config.dualAxis, position: 'right', grid: {drawOnChartArea: false} } } }
                });
            } else {
                const datasets = []; const colors = ['#000000', '#BE1E2D', '#666666', '#FF8A96', '#16a34a']; let cIdx = 0;
                Object.keys(data).forEach(dKey => {
                    if (!(config.exclude && config.exclude.some(e => dKey.includes(e))) && config.tags.some(t => dKey.includes(t)) && !used.has(dKey)) {
                        if (key === 'produtividade' && dKey.includes('vendas por m')) return;
                        used.add(dKey); const it = data[dKey];
                        const vals = [
                            key === 'margens' ? (it.v1 < 1 ? it.v1*100 : it.v1) : it.v1/config.div,
                            key === 'margens' ? (it.v2 < 1 ? it.v2*100 : it.v2) : it.v2/config.div,
                            key === 'margens' ? (it.v3 < 1 ? it.v3*100 : it.v3) : it.v3/config.div
                        ];
                        datasets.push({ label: it.original, info: it.desc, data: vals, borderColor: colors[cIdx++ % 5], backgroundColor: colors[cIdx % 5], tension: 0.3, pointRadius: 4, borderWidth: 2 });
                    }
                });
                charts[key] = new Chart(ctx, {
                    type: 'line', data: { labels: LABELS_TRI, datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { afterBody: (ctx) => ctx[0].dataset.info ? '\n'+ctx[0].dataset.info : '' }}}, scales: { y: { position: 'left', ticks: { callback: v => v.toLocaleString('pt-BR') + config.scale } } } }
                });
            }
        }

        async function gerarPDF() {
            const btn = document.getElementById('btn-pdf'); btn.innerText = "âŒ› CRIANDO PDF..."; btn.disabled = true;
            const printArea = document.createElement('div');
            printArea.style.width = '297mm'; printArea.style.margin = '0 auto';

            const capa = document.createElement('div');
            capa.className = 'page-content';
            capa.innerHTML = `<div style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; border: 4px solid #BE1E2D; border-radius: 20px;">
                <img src="logo.png" style="width:200px; margin-bottom:20px;">
                <h1 style="font-size:30px; font-weight:900;">RELATÃ“RIO ${currentMode}</h1>
                <h2 style="font-size:20px; color:#555;">CASA NOSTRA INDICADORES</h2>
                <span style="margin-top:20px; font-size:12px; font-weight:bold; color:#BE1E2D;">v${VERSION}</span>
            </div><div class="html2pdf__page-break"></div>`;
            printArea.appendChild(capa);

            const chaves = Object.keys(GRUPOS);
            for (let i = 0; i < chaves.length; i++) {
                const key = chaves[i];
                if (key === 'estoque_giro' && currentMode === 'TRIMESTRAL') continue;
                
                const config = GRUPOS[key];
                const slide = document.createElement('div');
                slide.className = 'page-content';

                let tableHeader = currentMode === 'ANUAL' 
                    ? `<tr><th style="padding:5px;">INDICADOR</th><th style="padding:5px;">${LABELS_ANUAL[0]}</th><th style="padding:5px;">${LABELS_ANUAL[1]}</th><th style="padding:5px;">NOTAS</th></tr>`
                    : `<tr><th style="padding:5px;">INDICADOR</th><th style="padding:5px;">${LABELS_TRI[0]}</th><th style="padding:5px;">${LABELS_TRI[1]}</th><th style="padding:5px;">${LABELS_TRI[2]}</th><th style="padding:5px;">NOTAS</th></tr>`;
                
                let rowsHtml = "";
                const used = new Set();
                Object.keys(masterData).forEach(mKey => {
                    if (!(config.exclude && config.exclude.some(e => mKey.includes(e))) && config.tags.some(t => mKey.includes(t)) && !used.has(mKey)) {
                        used.add(mKey); const it = masterData[mKey]; const isP = mKey.includes('margem');
                        
                        if (currentMode === 'ANUAL') {
                            const vPct = it.v1 !== 0 ? ((it.v2 - it.v1) / Math.abs(it.v1)) * 100 : 0;
                            rowsHtml += `<tr style="border-bottom:1px solid #ddd; font-size:10px;">
                                <td style="padding:4px 5px; width:45%;"><strong>${it.original}</strong><br><span style="font-size:7px; color:#666;">${it.desc}</span></td>
                                <td style="text-align:center;">${formatVal(it.v1, isP)}</td>
                                <td style="text-align:center; background:#fff5f5;"><strong>${formatVal(it.v2, isP)}</strong><br><span style="font-size:7px; color:${vPct>=0?'#16a34a':'#BE1E2D'}">${vPct>0?'+':''}${vPct.toFixed(1)}%</span></td>
                                <td style="font-size:7px; color:#444;">${it.note1 ? LABELS_ANUAL[0]+':'+it.note1 : ''} ${it.note2 ? LABELS_ANUAL[1]+':'+it.note2 : ''}</td></tr>`;
                        } else {
                            const vYoY = it.v1 !== 0 ? ((it.v3 - it.v1) / Math.abs(it.v1)) * 100 : 0;
                            const vQoQ = it.v2 !== 0 ? ((it.v3 - it.v2) / Math.abs(it.v2)) * 100 : 0;

                            rowsHtml += `<tr style="border-bottom:1px solid #ddd; font-size:10px;">
                                <td style="padding:4px 5px; width:35%;"><strong>${it.original}</strong><br><span style="font-size:7px; color:#666;">${it.desc}</span></td>
                                <td style="text-align:center;">${formatVal(it.v1, isP)}</td>
                                <td style="text-align:center;">${formatVal(it.v2, isP)}</td>
                                <td style="text-align:center; background:#fff5f5;">
                                    <strong>${formatVal(it.v3, isP)}</strong><br>
                                    <div style="display:flex; justify-content:center; gap:5px; font-size:7px;">
                                        <span style="color:${vYoY>=0?'#16a34a':'#BE1E2D'}">vs ${LABELS_TRI[0]}: ${vYoY>0?'+':''}${vYoY.toFixed(1)}%</span>
                                        <span style="color:#ccc">|</span>
                                        <span style="color:${vQoQ>=0?'#16a34a':'#BE1E2D'}">vs ${LABELS_TRI[1]}: ${vQoQ>0?'+':''}${vQoQ.toFixed(1)}%</span>
                                    </div>
                                </td>
                                <td style="font-size:7px; color:#444; width:20%;">${it.note1}</td></tr>`;
                        }
                    }
                });

                const chartImg = charts[key].toBase64Image();
                slide.innerHTML = `<div style="border:1px solid #eee; border-radius:15px; padding:15px; height:100%; display:flex; flex-direction:column;">
                        <div style="flex-shrink: 0;"> 
                            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:4px solid #BE1E2D; padding-bottom:5px; margin-bottom:10px;">
                                <h2 style="font-size:16px; font-weight:900; text-transform:uppercase; color:#000;">${config.title}</h2><span style="font-size:10px; color:#999;">CASA NOSTRA INDICADORES</span>
                            </div>
                            <table style="width:100%; border-collapse:collapse; margin-bottom:10px;"><thead style="background:#000; color:#fff; font-size:9px;">${tableHeader}</thead><tbody>${rowsHtml}</tbody></table>
                        </div>
                        <div style="flex-grow:1; display:flex; align-items:center; justify-content:center; overflow:hidden; min-height:0; padding-top:5px;">
                            <img src="${chartImg}" style="max-width:98%; max-height:100%; object-fit:contain; border:1px solid #eee; border-radius:10px;">
                        </div>
                    </div>${i < chaves.length - 1 ? '<div class="html2pdf__page-break"></div>' : ''}`;
                printArea.appendChild(slide);
                await new Promise(r => setTimeout(r, 400));
            }

            html2pdf().set({ margin: 0, filename: `CasaNostra_${currentMode}.pdf`, image: { type: 'jpeg', quality: 0.90 }, html2canvas: { scale: 1.5, useCORS: true, letterRendering: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['css', 'legacy'] } }).from(printArea).save().then(() => { btn.innerText = "ðŸ“¥ GERAR PDF"; btn.disabled = false; });
        }

        function getComment(sheet, row, col) { const cell = sheet[XLSX.utils.encode_cell({r:row, c:col})]; return cell?.c?.[0]?.t ? cell.c[0].t.split('\n').filter(l => !l.match(/\d{4}/)).join(' ').trim() : ""; }
        function formatVal(v, isP) { let n = Number(v) || 0; if (isP) return (n < 1 && n !== 0 ? n * 100 : n).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '%'; return n.toLocaleString('pt-BR'); }
        
        function openModal(it, mode) {
            document.getElementById('modalTitle').innerText = it.original;
            document.getElementById('modalDescB').innerText = it.desc || "Sem metodologia.";
            document.getElementById('detailsModal').style.display = 'flex';
            
            const varContainer = document.getElementById('modalVarContainer');

            if (mode === 'ANUAL') {
                document.getElementById('modalLeftLabel').innerText = LABELS_ANUAL[0];
                document.getElementById('modalRightLabel').innerText = LABELS_ANUAL[1];
                document.getElementById('modalVLeft').innerText = formatVal(it.v1, it.original.toLowerCase().includes('margem'));
                document.getElementById('modalVRight').innerText = formatVal(it.v2, it.original.toLowerCase().includes('margem'));
                document.getElementById('modalNote').innerText = (it.note1 ? LABELS_ANUAL[0]+": " + it.note1 : "") + (it.note2 ? "\n"+LABELS_ANUAL[1]+": " + it.note2 : "");
                
                // INJEÃ‡ÃƒO DA VARIAÃ‡ÃƒO NO MODAL ANUAL
                const varPct = it.v1 !== 0 ? ((it.v2 - it.v1) / Math.abs(it.v1)) * 100 : 0;
                varContainer.innerHTML = `<div class="bg-gray-50 px-4 py-2 rounded-xl border border-gray-100 flex-1"><span class="text-[9px] text-gray-400 uppercase font-bold block tracking-widest">VariaÃ§Ã£o Total</span><span class="${varPct >= 0 ? 'text-green-600' : 'text-red-600'} font-black text-lg">${varPct > 0 ? '+' : ''}${varPct.toFixed(1)}%</span></div>`;

                updateModalChart(it.original, [it.v1, it.v2], LABELS_ANUAL, 'bar', ['#000000', '#BE1E2D']);
            } else {
                document.getElementById('modalLeftLabel').innerText = LABELS_TRI[0];
                document.getElementById('modalRightLabel').innerText = LABELS_TRI[2];
                document.getElementById('modalVLeft').innerText = formatVal(it.v1, it.original.toLowerCase().includes('margem'));
                document.getElementById('modalVRight').innerText = formatVal(it.v3, it.original.toLowerCase().includes('margem'));
                document.getElementById('modalNote').innerText = it.note1 || "";
                
                // INJEÃ‡ÃƒO DA COMPARAÃ‡ÃƒO DUPLA NO MODAL TRIMESTRAL
                const varYoY = it.v1 !== 0 ? ((it.v3 - it.v1) / Math.abs(it.v1)) * 100 : 0;
                const varQoQ = it.v2 !== 0 ? ((it.v3 - it.v2) / Math.abs(it.v2)) * 100 : 0;
                varContainer.innerHTML = `
                    <div class="bg-gray-50 px-4 py-2 rounded-xl border border-gray-100 flex-1"><span class="text-[9px] text-gray-400 uppercase font-bold block tracking-widest">vs ${LABELS_TRI[0]}</span><span class="${varYoY >= 0 ? 'text-green-600' : 'text-red-600'} font-black text-lg">${varYoY > 0 ? '+' : ''}${varYoY.toFixed(1)}%</span></div>
                    <div class="bg-gray-50 px-4 py-2 rounded-xl border border-gray-100 flex-1"><span class="text-[9px] text-gray-400 uppercase font-bold block tracking-widest">vs ${LABELS_TRI[1]}</span><span class="${varQoQ >= 0 ? 'text-green-600' : 'text-red-600'} font-black text-lg">${varQoQ > 0 ? '+' : ''}${varQoQ.toFixed(1)}%</span></div>
                `;

                updateModalChart(it.original, [it.v1, it.v2, it.v3], LABELS_TRI, 'line', ['#BE1E2D']);
            }
        }

        function updateModalChart(l, data, labels, type, colors) { 
            const ctx = document.getElementById('modalChartCanvas').getContext('2d'); 
            if (modalChart) modalChart.destroy(); 
            
            let datasetConfig = {};
            if (type === 'bar') {
                datasetConfig = { label: l, data: data.map(v => l.toLowerCase().includes('margem') && v<1 ? v*100 : v), backgroundColor: colors, borderRadius: 10 };
            } else {
                datasetConfig = { label: l, data: data.map(v => l.toLowerCase().includes('margem') && v<1 ? v*100 : v), backgroundColor: colors[0], borderColor: colors[0], tension: 0.3 };
            }

            modalChart = new Chart(ctx, { type: type, data: { labels: labels, datasets: [datasetConfig] }, options: { responsive: true, maintainAspectRatio: false } }); 
        }
        
        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; }

        // --- ATALHO TECLA ESC PARA FECHAR O MODAL ---
        window.addEventListener('keydown', function (event) {
            if (event.key === 'Escape' && document.getElementById('detailsModal').style.display === 'flex') {
                closeModal();
            }
        });
    </script>

    <style>
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .chart-card { background: white; border-radius: 2rem; padding: 1.5rem; border: 1px solid #f3f4f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: all 0.3s; }
        .section-header { font-weight: 900; color: #9ca3af; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.3em; margin-bottom: 1.5rem; margin-top: 2rem; border-left: 4px solid #BE1E2D; padding-left: 1rem; }
        .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #000; color: white; border-radius: 50%; font-size: 10px; cursor: help; margin-left: 6px; font-weight: bold; font-style: italic; vertical-align: middle; }
        .page-content { width: 297mm; height: 209mm; padding: 10mm; background: white; box-sizing: border-box; overflow: hidden; page-break-after: always; }
        .html2pdf__page-break { height: 0; margin: 0; padding: 0; border: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans pb-12">
    <div id="detailsModal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] shadow-2xl max-w-5xl w-full flex flex-col md:flex-row h-[80vh] overflow-hidden">
            <div class="p-8 md:w-1/3 bg-gray-50 border-r border-gray-100 flex flex-col overflow-y-auto relative">
                <button onclick="closeModal()" class="text-gray-400 hover:text-black mb-6 font-bold text-xs uppercase text-left tracking-widest flex items-center gap-2">
                    <span>âœ• Fechar</span>
                    <span class="bg-gray-200 text-gray-500 text-[8px] px-2 py-1 rounded">ESC</span>
                </button>
                <h2 class="text-2xl font-black uppercase italic text-[#BE1E2D] mb-4" id="modalTitle"></h2>
                <p id="modalDescB" class="text-[11px] text-gray-500 italic mb-8 bg-gray-100 p-4 rounded-xl border border-gray-200"></p>
                <div class="space-y-4">
                    <div class="p-5 bg-white rounded-2xl border border-gray-100 shadow-sm"><span id="modalLeftLabel" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"></span><p id="modalVLeft" class="text-xl font-black mt-1"></p></div>
                    <div class="p-5 bg-white rounded-2xl border-l-4 border-[#BE1E2D] shadow-sm"><span id="modalRightLabel" class="text-[10px] font-bold text-[#BE1E2D] uppercase tracking-widest"></span><p id="modalVRight" class="text-xl font-black mt-1"></p></div>
                    
                    <div id="modalVarContainer" class="flex gap-2"></div>

                    <div id="modalNote" class="text-[10px] text-gray-500 mt-2 border-t pt-2 italic"></div>
                </div>
            </div>
            <div class="p-10 md:w-2/3 bg-white h-full flex flex-col justify-center"><canvas id="modalChartCanvas"></canvas></div>
        </div>
    </div>
    
    <nav class="bg-black text-white flex justify-between items-center shadow-xl border-b-4 border-[#BE1E2D] sticky top-0 z-40 h-20 px-6">
        <div class="flex items-center gap-6">
            <img src="logo.png" alt="Logo" class="h-14">
            <h1 class="text-lg font-black uppercase tracking-tight hidden md:block">CASA NOSTRA <span class="text-[#BE1E2D]">INDICADORES</span> <span class="text-[9px] text-gray-500 ml-2 italic tracking-widest">v2.3</span></h1>
            <div class="flex bg-gray-900 rounded-full p-1 ml-4">
                <button id="btn-anual" onclick="renderDashboard('ANUAL')" class="bg-[#BE1E2D] text-white px-6 py-2 rounded-full text-[10px] font-black shadow-lg">ANUAL</button>
                <button id="btn-tri" onclick="renderDashboard('TRIMESTRAL')" class="bg-gray-800 text-white px-6 py-2 rounded-full text-[10px] font-black opacity-50 hover:opacity-100">TRIMESTRAL</button>
            </div>
        </div>
        <div class="flex gap-3">
            <button id="btn-pdf" onclick="gerarPDF()" class="bg-white text-black px-6 py-2 rounded-full text-[10px] font-black shadow-lg hover:scale-105 transition-all">ðŸ“¥ GERAR PDF</button>
            <button onclick="handleAuthClick()" class="bg-gray-800 px-5 py-2 rounded-full text-[10px] font-black hover:bg-gray-700 transition-all">ðŸ”„ ATUALIZAR</button>
            <button onclick="handleAuthClick(true)" class="bg-[#BE1E2D] px-5 py-2 rounded-full text-[10px] font-black shadow-lg hover:brightness-110 transition-all">ðŸ“‚ TROCAR</button>
        </div>
    </nav>
    <main id="dashboard-content" class="p-6 max-w-[1600px] mx-auto"><div id="file-status" class="text-[10px] text-gray-400 mb-4 uppercase tracking-widest">Aguardando ConexÃ£o...</div><div id="cards-sections-container"></div><div class="border-t border-gray-200 pt-16 mt-16 grid grid-cols-1 lg:grid-cols-2 gap-8" id="charts-main-grid"></div></main>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>
