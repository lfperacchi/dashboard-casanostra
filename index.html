<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Casa Nostra | Business Intelligence</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const CLIENT_ID = '967312917527-sr2r24n2m9g0r3c5b7b87hpop3se3vh8.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBuVMvZuFTYAIcrlzK3YnB0sTGYsmlvZFA';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email';
        const ABA_ALVO = "Dashboard_Indicadores IPCA";

        const EMAILS_AUTORIZADOS = [
            'lfperacchi@gmail.com', 'lfperacchi.investidor@gmail.com',
            'miforalozzo@gmail.com', 'mepagliosa11@gmail.com',
            'sabrinapagliosaarquitetura@gmail.com'
        ];

        let tokenClient, charts = {};
        let currentFileId = localStorage.getItem('casaNostra_lastFileId');
        let currentFileName = localStorage.getItem('casaNostra_lastFileName');

        function gapiLoaded() {
            gapi.load('client:picker', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, ux_mode: 'popup',
                callback: async (resp) => {
                    if (resp.error) return;
                    if (await verificarAcesso(resp.access_token)) {
                        if (currentFileId) await downloadAndProcessFile(currentFileId);
                        else createPicker(resp.access_token);
                    }
                }
            });
        }

        async function verificarAcesso(accessToken) {
            const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const user = await resp.json();
            if (EMAILS_AUTORIZADOS.includes(user.email.toLowerCase())) return true;
            alert("Acesso Negado."); window.location.reload(); return false;
        }

        function handleAuthClick(force = false) {
            if (force) { currentFileId = null; localStorage.removeItem('casaNostra_lastFileId'); }
            if (tokenClient) tokenClient.requestAccessToken({prompt: currentFileId ? '' : 'consent'});
        }

        function createPicker(at) {
            const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
            new google.picker.PickerBuilder().addView(view).setOAuthToken(at).setDeveloperKey(API_KEY)
                .setCallback(pickerCallback).setOrigin(window.location.protocol + '//' + window.location.host).build().setVisible(true);
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                currentFileId = data.docs[0].id; currentFileName = data.docs[0].name;
                localStorage.setItem('casaNostra_lastFileId', currentFileId);
                localStorage.setItem('casaNostra_lastFileName', currentFileName);
                await downloadAndProcessFile(currentFileId);
            }
        }

        async function downloadAndProcessFile(id) {
            const token = gapi.client.getToken();
            const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media&t=${Date.now()}`, { headers: { 'Authorization': `Bearer ${token.access_token}` } });
            const wb = XLSX.read(new Uint8Array(await resp.arrayBuffer()), {type: 'array', cellComments: true});
            processDashboard(wb.Sheets[ABA_ALVO]);
            document.getElementById('file-status').innerText = "Conectado: " + currentFileName;
        }
    </script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <style>
        .bg-casa-red { background-color: #BE1E2D; }
        .text-casa-red { color: #BE1E2D; }
        .chart-card { background: white; border-radius: 1.5rem; padding: 1.5rem; border: 1px solid #f3f4f6; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .group-title { font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .group-obj { font-size: 0.7rem; color: #9ca3af; italic: true; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans pb-12">

    <nav class="bg-black text-white flex justify-between items-center shadow-xl border-b-4 border-casa-red sticky top-0 z-40 h-20 px-6">
        <div class="flex items-center gap-6 h-full">
            <img src="logo.png" alt="Logo" class="h-full w-auto object-contain py-2">
            <div>
                <h1 class="text-lg font-black uppercase tracking-tight leading-none">CASA NOSTRA <span class="text-casa-red">INTEL</span></h1>
                <span id="file-status" class="text-[10px] text-gray-400 uppercase tracking-widest">Aguardando ConexÃ£o...</span>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="gerarPDF()" class="bg-white text-black hover:bg-gray-100 px-4 py-2 rounded-full text-[10px] font-black shadow-lg">ðŸ“¥ PDF</button>
            <button onclick="handleAuthClick()" class="bg-gray-800 text-white hover:bg-gray-700 px-4 py-2 rounded-full text-[10px] font-black shadow-lg">ðŸ”„ ATUALIZAR</button>
            <button onclick="handleAuthClick(true)" class="bg-casa-red hover:bg-red-700 px-4 py-2 rounded-full text-[10px] font-black shadow-lg">ðŸ“‚ TROCAR</button>
        </div>
    </nav>

    <main id="dashboard-content" class="p-6 max-w-[1600px] mx-auto space-y-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="chart-card lg:col-span-2">
                <div class="group-title text-casa-red text-xl">1. Receitas e Resultados Brutos (M)</div>
                <div class="group-obj">Monitorar crescimento e eficiÃªncia na compra de mercadorias.</div>
                <div class="h-80"><canvas id="chart_receitas"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="group-title text-black">2. Lucratividade Operacional (k)</div>
                <div class="group-obj">SaÃºde financeira final e geraÃ§Ã£o de caixa.</div>
                <div class="h-72"><canvas id="chart_lucratividade"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="group-title text-black">3. EficiÃªncia e Margens (%)</div>
                <div class="group-obj">ConversÃ£o de vendas em lucro real.</div>
                <div class="h-72"><canvas id="chart_margens"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="group-title text-black">4. OPEX - Custos Fixos e VariÃ¡veis (k)</div>
                <div class="group-obj">Controle do "Custo Loja Aberta" e peso da folha.</div>
                <div class="h-72"><canvas id="chart_opex"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="group-title text-black">5. Performance e LogÃ­stica</div>
                <div class="group-obj">EficiÃªncia de estoque e produtividade por mÂ²/equipe.</div>
                <div class="h-72"><canvas id="chart_performance"></canvas></div>
            </div>

        </div>
    </main>

    <script>
        const GRUPOS = {
            receitas: {
                tags: ['receita bruta de vendas', 'receita lÃ­quida de vendas', 'cpv (custo dos produtos vendidos)', 'lucro bruto'],
                scale: 'M', divisor: 1000000
            },
            lucratividade: {
                tags: ['lucro operacional (nominal)', 'ebit (lucro antes de juros e impostos)', 'ebitda (lajida)', 'lucro lÃ­quido'],
                scale: 'k', divisor: 1000
            },
            margens: {
                tags: ['margem ebit', 'margem lÃ­quida', 'margem ebitda'],
                scale: '%', divisor: 1
            },
            opex: {
                tags: ['custo loja aberta mensal', 'gasto com pessoal', 'despesas administrativas', 'publicidade', 'frota'],
                scale: 'k', divisor: 1000
            },
            performance: {
                tags: ['vendas por m2', 'vendas por funcionÃ¡rio', 'estoque (valor)', 'giro de estoque', 'pmre (prazo mÃ©dio de renovaÃ§Ã£o de estoque)'],
                scale: 'U', divisor: 1
            }
        };

        function processDashboard(sheet) {
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            const dataMap = {};

            rows.forEach((row, idx) => {
                if (idx === 0 || !row[1]) return;
                const label = row[1].toString().toLowerCase().trim();
                dataMap[label] = {
                    original: row[1],
                    v24: Number(row[10]) || 0,
                    v25: Number(row[11]) || 0
                };
            });

            Object.keys(GRUPOS).forEach(key => renderThematicChart(key, dataMap));
        }

        function renderThematicChart(key, masterData) {
            const config = GRUPOS[key];
            const labels = [], d24 = [], d25 = [];
            
            config.tags.forEach(tag => {
                if (masterData[tag]) {
                    const item = masterData[tag];
                    labels.push(item.original);
                    const val24 = key === 'margens' ? item.v24 * 100 : item.v24 / config.divisor;
                    const val25 = key === 'margens' ? item.v25 * 100 : item.v25 / config.divisor;
                    d24.push(val24); d25.push(val25);
                }
            });

            const ctx = document.getElementById(`chart_${key}`).getContext('2d');
            if (charts[key]) charts[key].destroy();

            charts[key] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '2024', data: d24, backgroundColor: '#000', borderRadius: 5 },
                        { label: '2025', data: d25, backgroundColor: '#BE1E2D', borderRadius: 5 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } },
                        tooltip: { 
                            backgroundColor: 'rgba(0,0,0,0.8)', 
                            padding: 12,
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.parsed.y.toLocaleString('pt-BR')}${config.scale}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: { size: 9 },
                                callback: (v) => v.toLocaleString('pt-BR') + config.scale
                            }
                        },
                        x: { ticks: { font: { size: 9, weight: 'bold' } } }
                    }
                }
            });
        }

        function gerarPDF() {
            const element = document.getElementById('dashboard-content');
            html2pdf().set({
                margin: 10, filename: 'Casa_Nostra_Relatorio_Tematico.pdf',
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            }).from(element).save();
        }
    </script>
</body>
</html>
