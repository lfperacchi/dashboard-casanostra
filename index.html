<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Casa Nostra Intel | v1.0.5</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const VERSION = "1.0.5";
        const CLIENT_ID = '967312917527-sr2r24n2m9g0r3c5b7b87hpop3se3vh8.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBuVMvZuFTYAIcrlzK3YnB0sTGYsmlvZFA';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email';
        const ABA_ALVO = "Dashboard_Indicadores IPCA";

        const EMAILS_AUTORIZADOS = [
            'lfperacchi@gmail.com', 'lfperacchi.investidor@gmail.com',
            'miforalozzo@gmail.com', 'mepagliosa11@gmail.com',
            'sabrinapagliosaarquitetura@gmail.com'
        ];

        let tokenClient, charts = {}, modalChart = null, masterData = {};
        let currentFileId = localStorage.getItem('casaNostra_lastFileId');

        function gapiLoaded() { gapi.load('client:picker', async () => { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] }); }); }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, ux_mode: 'popup',
                callback: async (resp) => {
                    if (resp.error) return;
                    if (await verificarAcesso(resp.access_token)) {
                        if (currentFileId) downloadAndProcessFile(currentFileId);
                        else createPicker(resp.access_token);
                    }
                }
            });
        }
        async function verificarAcesso(at) {
            const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${at}` } });
            const user = await resp.json();
            if (EMAILS_AUTORIZADOS.includes(user.email.toLowerCase())) return true;
            alert("Acesso Negado."); return false;
        }
        function handleAuthClick(f = false) {
            if (f) { currentFileId = null; localStorage.removeItem('casaNostra_lastFileId'); }
            tokenClient.requestAccessToken({prompt: currentFileId ? '' : 'consent'});
        }
        function createPicker(at) {
            const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
            new google.picker.PickerBuilder().addView(view).setOAuthToken(at).setDeveloperKey(API_KEY).setCallback(pickerCallback).build().setVisible(true);
        }
        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                currentFileId = data.docs[0].id;
                localStorage.setItem('casaNostra_lastFileId', currentFileId);
                downloadAndProcessFile(currentFileId);
            }
        }
        async function downloadAndProcessFile(id) {
            const token = gapi.client.getToken();
            const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media&t=${Date.now()}`, { headers: { 'Authorization': `Bearer ${token.access_token}` } });
            const wb = XLSX.read(new Uint8Array(await resp.arrayBuffer()), {type: 'array', cellComments: true});
            processDashboard(wb.Sheets[ABA_ALVO]);
            document.getElementById('file-status').innerText = "Conectado: " + data.docs[0].name;
        }

        // --- L√ìGICA DE INTERFACE ---
        const GRUPOS = {
            receitas: { title: "1. Receitas", tags: ['receita bruta', 'receita l√≠quida'], div: 1000000, scale: 'M', exclude: ['cpv', 'lucro bruto'] },
            lucratividade: { title: "2. Lucratividade", tags: ['lucro operacional', 'ebit', 'ebitda', 'lucro l√≠quido', 'lucro nominal', 'resultado operacional', 'lucro bruto'], exclude: ['margem'], div: 1000, scale: 'k' },
            margens: { title: "3. Margens", tags: ['margem ebit', 'margem l√≠quida', 'margem ebitda'], div: 1, scale: '%' },
            opex_a: { title: "4. Pessoal e Impostos", tags: ['despesas operacionais', 'impostos totais', 'gasto com pessoal'], div: 1000, scale: 'k' },
            opex_b: { title: "5. Administrativo", tags: ['administrativo', 'publicidade', 'frota'], div: 1000, scale: 'k' },
            estoque_fin: { title: "6. Estoque e Custos", tags: ['aquisi√ß√£o de produtos', 'cpv', 'estoque'], div: 1000, scale: 'k', exclude: ['pmre', 'giro'] },
            estoque_giro: { title: "7. PMRE e Giro", tags: ['pmre', 'giro de renova√ß√£o'], div: 1, scale: '', dualAxis: true },
            produtividade: { title: "8. Produtividade", tags: ['vendas por m2', 'custo loja aberta', 'vendas por funcion√°rio'], div: 1, scale: '' },
            capex: { title: "9. Capex e Deprec.", tags: ['capex total', 'deprecia√ß√£o', 'amortiza√ß√£o'], div: 1000, scale: 'k' }
        };

        function getComment(sheet, row, col) {
            const cell = sheet[XLSX.utils.encode_cell({r:row, c:col})];
            if (!cell?.c?.[0]?.t) return "";
            return cell.c[0].t.split('\n').filter(l => !l.match(/\d{4}/) && !l.includes('ID#')).join(' ').trim();
        }

        function formatVal(v, isP) {
            let n = Number(v) || 0;
            if (isP) return (n < 1 && n !== 0 ? n * 100 : n).toLocaleString('pt-PT', { minimumFractionDigits: 2 }) + '%';
            return n.toLocaleString('pt-PT');
        }

        function processDashboard(sheet) {
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            masterData = {};
            const container = document.getElementById('cards-sections-container');
            const chartsGrid = document.getElementById('charts-main-grid');
            container.innerHTML = ''; chartsGrid.innerHTML = '';

            rows.forEach((row, idx) => {
                if (idx === 0 || !row[1]) return;
                const labelRaw = row[1].toString(); const labelLow = labelRaw.toLowerCase().trim();
                masterData[labelLow] = { 
                    original: labelRaw, 
                    v24: Number(row[10]) || 0, v25: Number(row[11]) || 0,
                    commB: getComment(sheet, idx, 1), commK: getComment(sheet, idx, 10), commL: getComment(sheet, idx, 11)
                };
            });

            Object.keys(GRUPOS).forEach(key => {
                const config = GRUPOS[key];
                const section = document.createElement('div');
                section.innerHTML = `<div class="section-header">${config.title}</div><div id="grid-${key}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>`;
                container.appendChild(section);

                const chartCard = document.createElement('div');
                chartCard.className = `chart-card ${key === 'receitas' ? 'lg:col-span-2' : ''}`;
                chartCard.innerHTML = `<div class="font-black text-black text-lg uppercase mb-4">${config.title}</div><div class="h-80"><canvas id="chart_${key}"></canvas></div>`;
                chartsGrid.appendChild(chartCard);

                const usedInBlock = new Set();
                Object.keys(masterData).forEach(mKey => {
                    const isEx = config.exclude && config.exclude.some(e => mKey.includes(e));
                    if (!isEx && config.tags.some(t => mKey.includes(t)) && !usedInBlock.has(mKey)) {
                        usedInBlock.add(mKey); const it = masterData[mKey]; const isP = mKey.includes('margem');
                        const varPct = it.v24 !== 0 ? ((it.v25 - it.v24) / Math.abs(it.v24)) * 100 : 0;
                        const card = document.createElement('div');
                        card.className = "bg-white p-6 rounded-3xl border border-gray-100 shadow-sm cursor-pointer card-kpi flex flex-col justify-between h-44";
                        card.onclick = () => openModal(it.original, it.v24, it.v25, it.commB, it.commK, it.commL, varPct);
                        card.innerHTML = `<div><p class="text-[9px] text-gray-400 font-black uppercase tracking-widest flex items-center" title="${it.commB.replace(/"/g, '&quot;')}">
                                            ${it.original} ${it.commB ? '<span class="info-icon">i</span>' : ''}
                                          </p><span class="text-3xl font-black mt-2 block">${formatVal(it.v25, isP)}</span></div>
                                          <div class="flex justify-between border-t pt-3"><span class="text-[10px] text-gray-300">2024: ${formatVal(it.v24, isP)}</span>
                                          <span class="${varPct >= 0 ? 'text-green-600' : 'text-red-600'} text-[11px] font-bold">${varPct > 0 ? '+' : ''}${varPct.toFixed(1)}%</span></div>`;
                        document.getElementById(`grid-${key}`).appendChild(card);
                    }
                });
                renderThematicChart(key, masterData);
            });
        }

        function renderThematicChart(key, data) {
            const config = GRUPOS[key]; const labels = [], d24 = [], d25 = [], dual24 = [], dual25 = [], methods = [];
            const used = new Set();
            Object.keys(data).forEach(dKey => {
                const ex = config.exclude && config.exclude.some(e => dKey.includes(e));
                if (!ex && config.tags.some(t => dKey.includes(t)) && !used.has(dKey)) {
                    used.add(dKey); const it = data[dKey];
                    if (config.dualAxis) {
                        if (dKey.includes('pmre')) { d24.push(it.v24); d25.push(it.v25); labels.push(it.original); }
                        else { dual24.push(it.v24); dual25.push(it.v25); }
                    } else {
                        labels.push(it.original); d24.push(key === 'margens' ? (it.v24 < 1 ? it.v24 * 100 : it.v24) : it.v24 / config.div); d25.push(key === 'margens' ? (it.v25 < 1 ? it.v25 * 100 : it.v25) : it.v25 / config.div);
                    }
                    methods.push(it.commB);
                }
            });
            const ctx = document.getElementById(`chart_${key}`).getContext('2d');
            charts[key] = new Chart(ctx, {
                type: 'bar',
                data: { labels: config.dualAxis ? ['KPIs de Estoque'] : labels, datasets: config.dualAxis ? [
                    { label: 'PMRE 2024', data: d24, backgroundColor: '#000', yAxisID: 'y' }, { label: 'PMRE 2025', data: d25, backgroundColor: '#BE1E2D', yAxisID: 'y' },
                    { label: 'Giro 2024', data: dual24, backgroundColor: '#666', yAxisID: 'y1' }, { label: 'Giro 2025', data: dual25, backgroundColor: '#FF8A96', yAxisID: 'y1' }
                ] : [{ label: '2024', data: d24, backgroundColor: '#000', info: methods }, { label: '2025', data: d25, backgroundColor: '#BE1E2D', info: methods }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { afterBody: (ctx) => ctx[0].dataset.info ? '\nDefini√ß√£o: ' + ctx[0].dataset.info[ctx[0].dataIndex] : '' } } }, scales: { y: { position: 'left', min: 0, max: config.dualAxis ? 360 : undefined, ticks: { callback: v => v.toLocaleString('pt-PT') + config.scale } }, y1: config.dualAxis ? { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } } : { display: false } } }
            });
        }

        async function gerarPDF() {
            const btn = document.getElementById('btn-pdf'); btn.innerText = "‚åõ GERANDO..."; btn.disabled = true;
            const printContent = document.createElement('div');
            printContent.style.padding = '5mm'; printContent.style.width = '285mm'; // A4 Landscape aprox.

            printContent.innerHTML = `<div style="display:flex; justify-content:space-between; border-bottom:4px solid #BE1E2D; padding-bottom:10px; margin-bottom:30px;">
                <h1 style="font-size:22px; font-weight:900;">RELAT√ìRIO CASA NOSTRA INTEL</h1>
                <span style="font-size:10px; color:#999; font-weight:bold;">v${VERSION}</span></div>`;

            // 1. BLOCOS DE KPIs (Boxes)
            for (const key of Object.keys(GRUPOS)) {
                const config = GRUPOS[key];
                const section = document.createElement('div');
                section.style.pageBreakInside = 'avoid';
                section.style.marginBottom = '25px';
                
                let tableHtml = `<h2 style="font-size:12px; font-weight:800; text-transform:uppercase; border-left:4px solid #BE1E2D; padding-left:10px; margin-bottom:10px; background:#f9f9f9;">${config.title}</h2>
                                <table style="width:100%; border-collapse:collapse; margin-bottom:10px;">
                                <thead style="background:#000; color:#fff; font-size:8px;"><tr><th style="padding:5px; text-align:left;">INDICADOR / METODOLOGIA</th><th style="padding:5px;">REAL 2024</th><th style="padding:5px;">REAL 2025</th><th style="padding:5px; text-align:left;">OBSERVA√á√ïES (K/L)</th></tr></thead><tbody>`;

                const used = new Set();
                Object.keys(masterData).forEach(mKey => {
                    const isEx = config.exclude && config.exclude.some(e => mKey.includes(e));
                    if (!isEx && config.tags.some(t => mKey.includes(t)) && !used.has(mKey)) {
                        used.add(mKey); const it = masterData[mKey]; const isP = mKey.includes('margem');
                        const varPct = it.v24 !== 0 ? ((it.v25 - it.v24) / Math.abs(it.v24)) * 100 : 0;
                        tableHtml += `<tr style="border-bottom:1px solid #eee; font-size:9px;">
                            <td style="padding:6px; width:35%;"><strong>${it.original}</strong><br><span style="font-size:7px; color:#666;">${it.commB}</span></td>
                            <td style="padding:6px; text-align:center;">${formatVal(it.v24, isP)}</td>
                            <td style="padding:6px; text-align:center; background:#fffcfc;"><strong>${formatVal(it.v25, isP)}</strong><br><span style="font-size:8px; color:${varPct>=0?'#16a34a':'#BE1E2D'}">${varPct>0?'+':''}${varPct.toFixed(1)}%</span></td>
                            <td style="padding:6px; font-size:8px; color:#555;">${it.commK ? '<strong>24:</strong> '+it.commK : ''}${it.commL ? '<br><strong>25:</strong> '+it.commL : ''}</td></tr>`;
                    }
                });
                tableHtml += `</tbody></table>`;
                section.innerHTML = tableHtml;
                printContent.appendChild(section);
            }

            // 2. BLOCOS DE GR√ÅFICOS (9 blocos garantidos)
            const gHeader = document.createElement('div');
            gHeader.style.pageBreakBefore = 'always';
            gHeader.innerHTML = `<h2 style="font-size:18px; font-weight:900; margin-bottom:20px; border-bottom:2px solid #000;">AN√ÅLISE GR√ÅFICA COMPARATIVA</h2>`;
            printContent.appendChild(gHeader);

            for (const key of Object.keys(GRUPOS)) {
                const config = GRUPOS[key];
                const chartImg = charts[key].toBase64Image();
                const div = document.createElement('div');
                div.style.pageBreakInside = 'avoid';
                div.style.marginBottom = '40px';
                
                let resTable = `<table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:9px; text-align:center;">
                    <tr style="background:#eee; font-weight:bold;"><td>Indicador</td><td>2024</td><td>2025</td><td>Var. %</td></tr>`;
                
                const usedRes = new Set();
                Object.keys(masterData).forEach(mKey => {
                    const isEx = config.exclude && config.exclude.some(e => mKey.includes(e));
                    if (!isEx && config.tags.some(t => mKey.includes(t)) && !usedRes.has(mKey)) {
                        usedRes.add(mKey); const it = masterData[mKey];
                        const vP = it.v24 !== 0 ? ((it.v25 - it.v24) / Math.abs(it.v24)) * 100 : 0;
                        resTable += `<tr><td style="text-align:left; font-weight:bold; padding:4px;">${it.original}</td><td>${formatVal(it.v24, mKey.includes('margem'))}</td><td>${formatVal(it.v25, mKey.includes('margem'))}</td><td style="color:${vP>=0?'#16a34a':'#BE1E2D'}">${vP>0?'+':''}${vP.toFixed(1)}%</td></tr>`;
                    }
                });
                resTable += `</table>`;

                div.innerHTML = `<h3 style="font-size:13px; font-weight:800; text-transform:uppercase; margin-bottom:10px;">${config.title}</h3>
                    <img src="${chartImg}" style="width:100%; border:1px solid #eee; border-radius:10px;">
                    ${resTable}`;
                printContent.appendChild(div);
                await new Promise(r => setTimeout(r, 150));
            }

            const opt = { margin:0, filename:`Relatorio_CasaNostra_v${VERSION}.pdf`, html2canvas:{scale:2, useCORS:true}, jsPDF:{format:'a4', orientation:'landscape'} };
            html2pdf().set(opt).from(printContent).save().then(() => { btn.innerText = "üì• GERAR PDF"; btn.disabled = false; });
        }

        function openModal(l, v24, v25, cb, ck, cl, varPct) {
            document.getElementById('modalTitle').innerText = l;
            document.getElementById('modalV24').innerText = formatVal(v24, l.toLowerCase().includes('margem'));
            document.getElementById('modalV25').innerText = formatVal(v25, l.toLowerCase().includes('margem'));
            document.getElementById('modalDescB').innerText = cb || "Defini√ß√£o n√£o cadastrada.";
            document.getElementById('modalNoteK').innerText = ck ? "Nota 2024: " + ck : "";
            document.getElementById('modalNoteL').innerText = cl ? "Nota 2025: " + cl : "";
            document.getElementById('detailsModal').style.display = 'flex';
            setTimeout(() => {
                const ctx = document.getElementById('modalChartCanvas').getContext('2d');
                if (modalChart) modalChart.destroy();
                modalChart = new Chart(ctx, { type: 'bar', data: { labels: ['2024', '2025'], datasets: [{ label: l, data: [l.toLowerCase().includes('margem') ? v24*100 : v24, l.toLowerCase().includes('margem') ? v25*100 : v25], backgroundColor: ['#000', '#BE1E2D'], borderRadius: 10 }] }, options: { responsive: true, maintainAspectRatio: false } });
            }, 100);
        }
        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans pb-12">
    <nav class="bg-black text-white flex justify-between items-center shadow-xl border-b-4 border-casa-red sticky top-0 z-40 h-20 px-6">
        <div class="flex items-center gap-6"><img src="logo.png" alt="Logo" class="h-12 w-auto"><div><h1 class="text-lg font-black uppercase tracking-tight">CASA NOSTRA <span class="text-casa-red">INTEL</span></h1><span class="text-[9px] bg-gray-800 px-2 py-0.5 rounded text-gray-400 uppercase tracking-widest">Modelo v1.0.5</span></div></div>
        <div class="flex gap-3"><button id="btn-pdf" onclick="gerarPDF()" class="bg-white text-black px-6 py-2 rounded-full text-[10px] font-black shadow-lg hover:bg-gray-100">üì• GERAR PDF</button><button onclick="handleAuthClick()" class="bg-gray-800 text-white px-5 py-2 rounded-full text-[10px] font-black">üîÑ ATUALIZAR</button><button onclick="handleAuthClick(true)" class="bg-casa-red text-white px-5 py-2 rounded-full text-[10px] font-black">üìÇ TROCAR</button></div>
    </nav>
    <main id="dashboard-content" class="p-6 max-w-[1600px] mx-auto"><div id="file-status" class="text-[10px] text-gray-400 mb-4 uppercase">Conectando...</div><div id="cards-sections-container"></div><div class="border-t border-gray-200 pt-16 mt-16 grid grid-cols-1 lg:grid-cols-2 gap-8" id="charts-main-grid"></div></main>
</body>
</html>
