<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Dashboard Casa Nostra | Intel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const CLIENT_ID = '967312917527-sr2r24n2m9g0r3c5b7b87hpop3se3vh8.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBuVMvZuFTYAIcrlzK3YnB0sTGYsmlvZFA';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email';
        const ABA_ALVO = "Dashboard_Indicadores IPCA";

        const EMAILS_AUTORIZADOS = [
            'lfperacchi@gmail.com', 'lfperacchi.investidor@gmail.com',
            'miforalozzo@gmail.com', 'mepagliosa11@gmail.com',
            'sabrinapagliosaarquitetura@gmail.com'
        ];

        let tokenClient, charts = {}, modalChart = null;
        let currentFileId = localStorage.getItem('casaNostra_lastFileId');
        let currentFileName = localStorage.getItem('casaNostra_lastFileName');

        function gapiLoaded() {
            gapi.load('client:picker', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, ux_mode: 'popup',
                callback: async (resp) => {
                    if (resp.error) return;
                    if (await verificarAcesso(resp.access_token)) {
                        if (currentFileId) await downloadAndProcessFile(currentFileId);
                        else createPicker(resp.access_token);
                    }
                }
            });
        }

        async function verificarAcesso(accessToken) {
            const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const user = await resp.json();
            if (EMAILS_AUTORIZADOS.includes(user.email.toLowerCase())) return true;
            alert("Acesso Negado."); window.location.reload(); return false;
        }

        function handleAuthClick(f = false) {
            if (f) { currentFileId = null; localStorage.removeItem('casaNostra_lastFileId'); }
            if (tokenClient) tokenClient.requestAccessToken({prompt: currentFileId ? '' : 'consent'});
        }

        function createPicker(at) {
            const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
            new google.picker.PickerBuilder().addView(view).setOAuthToken(at).setDeveloperKey(API_KEY)
                .setCallback(pickerCallback).setOrigin(window.location.protocol + '//' + window.location.host).build().setVisible(true);
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                currentFileId = data.docs[0].id; currentFileName = data.docs[0].name;
                localStorage.setItem('casaNostra_lastFileId', currentFileId);
                localStorage.setItem('casaNostra_lastFileName', currentFileName);
                await downloadAndProcessFile(currentFileId);
            }
        }

        async function downloadAndProcessFile(id) {
            const token = gapi.client.getToken();
            const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media&t=${Date.now()}`, { headers: { 'Authorization': `Bearer ${token.access_token}` } });
            const wb = XLSX.read(new Uint8Array(await resp.arrayBuffer()), {type: 'array', cellComments: true});
            processDashboard(wb.Sheets[ABA_ALVO]);
            document.getElementById('file-status').innerText = "Conectado: " + currentFileName;
        }
    </script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <style>
        .bg-casa-red { background-color: #BE1E2D; }
        .text-casa-red { color: #BE1E2D; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .chart-card { background: white; border-radius: 1.5rem; padding: 1.5rem; border: 1px solid #f3f4f6; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .section-header { font-weight: 900; color: #9ca3af; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.3em; margin-bottom: 1.5rem; margin-top: 2rem; border-left: 4px solid #BE1E2D; padding-left: 1rem; }
        .card-kpi:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -5px rgba(190, 30, 45, 0.2); transition: all 0.3s; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans pb-12">

    <div id="detailsModal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-6xl w-full overflow-hidden flex flex-col md:flex-row h-[85vh]">
            <div class="p-8 md:w-1/3 bg-gray-50 border-r border-gray-100 flex flex-col overflow-y-auto">
                <button onclick="closeModal()" class="text-gray-400 hover:text-black mb-8 font-bold text-xs uppercase text-left tracking-widest">‚úï Fechar</button>
                <h2 class="text-2xl font-black uppercase italic text-casa-red leading-tight mb-8" id="modalTitle">Indicador</h2>
                <div class="space-y-6 flex-grow">
                    <div class="p-5 bg-white rounded-2xl border border-gray-100 h-32 flex flex-col justify-center shadow-sm">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Realizado 2024</span>
                        <p id="modalV24" class="text-2xl font-black mt-1">0</p>
                    </div>
                    <div class="p-5 bg-white rounded-2xl border-l-4 border-casa-red h-32 flex flex-col justify-center shadow-sm">
                        <span class="text-[10px] font-bold text-casa-red uppercase tracking-widest">Realizado 2025</span>
                        <p id="modalV25" class="text-2xl font-black mt-1">0</p>
                    </div>
                </div>
            </div>
            <div class="p-10 md:w-2/3 bg-white h-full flex flex-col justify-center relative">
                <canvas id="modalChartCanvas"></canvas>
            </div>
        </div>
    </div>

    <nav class="bg-black text-white flex justify-between items-center shadow-xl border-b-4 border-casa-red sticky top-0 z-40 h-20 px-6">
        <div class="flex items-center gap-6">
            <img src="logo.png" alt="Logo" class="h-12 w-auto">
            <h1 class="text-lg font-black uppercase tracking-tight">CASA NOSTRA <span class="text-casa-red">INTEL</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="handleAuthClick()" class="bg-gray-800 text-white px-5 py-2 rounded-full text-[10px] font-black shadow-lg">üîÑ ATUALIZAR</button>
            <button onclick="handleAuthClick(true)" class="bg-casa-red text-white px-5 py-2 rounded-full text-[10px] font-black shadow-lg">üìÇ TROCAR</button>
        </div>
    </nav>

    <main id="dashboard-content" class="p-6 max-w-[1600px] mx-auto">
        <div id="cards-sections-container"></div>
        <div class="border-t border-gray-200 pt-16 mt-16 space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-card lg:col-span-2"><div class="font-black text-casa-red text-xl uppercase mb-6">1. Receitas de Vendas (M)</div><div class="h-80"><canvas id="chart_receitas"></canvas></div></div>
                <div class="chart-card"><div class="font-black text-black text-lg uppercase mb-6">2. Lucratividade Operacional (k)</div><div class="h-72"><canvas id="chart_lucratividade"></canvas></div></div>
                <div class="chart-card"><div class="font-black text-black text-lg uppercase mb-6">3. Margens de Efici√™ncia (%)</div><div class="h-72"><canvas id="chart_margens"></canvas></div></div>
                <div class="chart-card"><div class="font-black text-black text-lg uppercase mb-6">4. OPEX: Pessoal e Impostos (k)</div><div class="h-72"><canvas id="chart_opex_a"></canvas></div></div>
                <div class="chart-card"><div class="font-black text-black text-lg uppercase mb-6">5. OPEX: Gest√£o Administrativa (k)</div><div class="h-72"><canvas id="chart_opex_b"></canvas></div></div>
                <div class="chart-card"><div class="font-black text-black text-lg uppercase mb-6">6. Fluxo de Estoque e Aquisi√ß√£o (k)</div><div class="h-72"><canvas id="chart_estoque_fin"></canvas></div></div>
                <div class="chart-card"><div class="font-black text-black text-lg uppercase mb-6">7. Efici√™ncia: PMRE e Giro de Estoque</div><div class="h-72"><canvas id="chart_estoque_giro"></canvas></div></div>
                <div class="chart-card"><div class="font-black text-black text-lg uppercase mb-6">8. Produtividade e Custo Loja</div><div class="h-72"><canvas id="chart_produtividade"></canvas></div></div>
                <div class="chart-card"><div class="font-black text-black text-lg uppercase mb-6">9. Capex e Deprecia√ß√£o (k)</div><div class="h-72"><canvas id="chart_capex"></canvas></div></div>
            </div>
        </div>
    </main>

    <script>
        const GRUPOS = {
            receitas: { title: "1. Receitas", tags: ['receita bruta', 'receita l√≠quida'], div: 1000000, scale: 'M' },
            lucratividade: { title: "2. Lucratividade", tags: ['lucro operacional', 'ebit', 'ebitda', 'lucro l√≠quido', 'lucro nominal', 'resultado operacional', 'lucro bruto'], exclude: ['margem'], div: 1000, scale: 'k' },
            margens: { title: "3. Margens", tags: ['margem ebit', 'margem l√≠quida', 'margem ebitda'], div: 1, scale: '%' },
            opex_a: { title: "4. Pessoal e Impostos", tags: ['despesas operacionais', 'impostos totais', 'gasto com pessoal'], div: 1000, scale: 'k' },
            opex_b: { title: "5. Administrativo", tags: ['administrativo', 'publicidade', 'frota'], div: 1000, scale: 'k' },
            estoque_fin: { title: "6. Estoque e Custos", tags: ['aquisi√ß√£o de produtos', 'cpv', 'estoque'], div: 1000, scale: 'k', exclude: ['pmre', 'giro'] },
            estoque_giro: { title: "7. PMRE e Giro", tags: ['pmre', 'giro de renova√ß√£o'], div: 1, scale: '', dualAxis: true },
            produtividade: { title: "8. Produtividade", tags: ['vendas por m2', 'custo loja aberta', 'vendas por funcion√°rio'], div: 1, scale: '' },
            capex: { title: "9. Capex e Deprec.", tags: ['capex total', 'deprecia√ß√£o', 'amortiza√ß√£o'], div: 1000, scale: 'k' }
        };

        function formatVal(v, isP) {
            let n = Number(v) || 0;
            if (isP) return (n < 1 && n !== 0 ? n * 100 : n).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + '%';
            return n.toLocaleString('pt-BR');
        }

        function processDashboard(sheet) {
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            const masterData = {};
            const container = document.getElementById('cards-sections-container');
            container.innerHTML = '';

            rows.forEach((row, idx) => {
                if (idx === 0 || !row[1]) return;
                const labelRaw = row[1].toString(); const labelLow = labelRaw.toLowerCase().trim();
                masterData[labelLow] = { original: labelRaw, v24: Number(row[10]) || 0, v25: Number(row[11]) || 0 };
            });

            Object.keys(GRUPOS).forEach(key => {
                const config = GRUPOS[key];
                const section = document.createElement('div');
                section.innerHTML = `<div class="section-header">${config.title}</div><div id="grid-${key}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>`;
                container.appendChild(section);

                Object.keys(masterData).forEach(mKey => {
                    const ex = config.exclude && config.exclude.some(e => mKey.includes(e));
                    if (!ex && config.tags.some(t => mKey.includes(t))) {
                        const item = masterData[mKey];
                        const varPct = item.v24 !== 0 ? ((item.v25 - item.v24) / Math.abs(item.v24)) * 100 : 0;
                        const card = document.createElement('div');
                        card.className = "bg-white p-6 rounded-3xl border border-gray-100 shadow-sm cursor-pointer card-kpi flex flex-col justify-between h-44";
                        card.onclick = () => openModal(item.original, item.v24, item.v25, varPct);
                        card.innerHTML = `<div><p class="text-[9px] text-gray-400 font-black uppercase tracking-widest">${item.original}</p><span class="text-3xl font-black block mt-2">${formatVal(item.v25, mKey.includes('margem'))}</span></div><div class="flex justify-between border-t pt-3"><span class="text-[10px] text-gray-300">2024: ${formatVal(item.v24, mKey.includes('margem'))}</span><span class="${varPct >= 0 ? 'text-green-600' : 'text-red-600'} text-[11px] font-bold">${varPct > 0 ? '+' : ''}${varPct.toFixed(1)}%</span></div>`;
                        document.getElementById(`grid-${key}`).appendChild(card);
                    }
                });
            });
            Object.keys(GRUPOS).forEach(key => renderThematicChart(key, masterData));
        }

        function renderThematicChart(key, data) {
            const config = GRUPOS[key]; const labels = [], pmre24 = [], pmre25 = [], giro24 = [], giro25 = [];
            const isDual = config.dualAxis;

            config.tags.forEach(tag => {
                Object.keys(data).forEach(dKey => {
                    if (dKey.includes(tag)) {
                        const item = data[dKey];
                        if (isDual) {
                            if (dKey.includes('pmre')) { pmre24.push(item.v24); pmre25.push(item.v25); }
                            else if (dKey.includes('giro')) { giro24.push(item.v24); giro25.push(item.v25); }
                        } else {
                            labels.push(item.original);
                            pmre24.push(key === 'margens' ? (item.v24 < 1 ? item.v24 * 100 : item.v24) : item.v24 / config.div);
                            pmre25.push(key === 'margens' ? (item.v25 < 1 ? item.v25 * 100 : item.v25) : item.v25 / config.div);
                        }
                    }
                });
            });

            const ctx = document.getElementById(`chart_${key}`).getContext('2d');
            if (charts[key]) charts[key].destroy();

            const datasets = isDual ? [
                { label: 'PMRE 2024', data: pmre24, backgroundColor: '#000', yAxisID: 'y' },
                { label: 'PMRE 2025', data: pmre25, backgroundColor: '#BE1E2D', yAxisID: 'y' },
                { label: 'Giro 2024', data: giro24, backgroundColor: '#666', yAxisID: 'y1' },
                { label: 'Giro 2025', data: giro25, backgroundColor: '#FF8A96', yAxisID: 'y1' }
            ] : [
                { label: '2024', data: pmre24, backgroundColor: '#000' },
                { label: '2025', data: pmre25, backgroundColor: '#BE1E2D' }
            ];

            charts[key] = new Chart(ctx, {
                type: 'bar',
                data: { labels: isDual ? ['Efici√™ncia de Estoque'] : labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', min: 0, max: isDual ? 360 : undefined, title: { display: isDual, text: 'Dias (PMRE)' } },
                        y1: isDual ? { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Vezes (Giro)', color: '#FF8A96' } } : { display: false }
                    }
                }
            });
        }

        function openModal(l, v24, v25, varPct) {
            document.getElementById('modalTitle').innerText = l;
            document.getElementById('modalV24').innerText = formatVal(v24, l.toLowerCase().includes('margem'));
            document.getElementById('modalV25').innerText = formatVal(v25, l.toLowerCase().includes('margem'));
            document.getElementById('detailsModal').style.display = 'flex';
            
            // For√ßa um pequeno delay para o canvas reconhecer o tamanho do container
            setTimeout(() => {
                const ctx = document.getElementById('modalChartCanvas').getContext('2d');
                if (modalChart) modalChart.destroy();
                modalChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['2024', '2025'],
                        datasets: [{ label: l, data: [l.toLowerCase().includes('margem') ? v24*100 : v24, l.toLowerCase().includes('margem') ? v25*100 : v25], backgroundColor: ['#000', '#BE1E2D'], borderRadius: 10 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }, 100); // 100ms para estabilizar
        }

        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; }
    </script>
</body>
</html>
